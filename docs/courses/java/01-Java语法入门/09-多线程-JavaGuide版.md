---
title: 09-多线程-JavaGuide版
author: Ray
date: 2020/10/02 21:30
categories:
 - Java生态
tags:
 - Java
 - Java基础
 - JDK
 - 开发环境
---
## 什么是进程和线程

### 进程

进程是程序的一次**执行过程**,**是系统运行程序的基本单位**(任务管理器看到的说明程序正在运行),因此进程是动态的。系统运行程序即是一个进程从创建,运行到消亡的过程。
在Java中,我们启动main函数就是启动了一个JVM的进程,main函数所在的线程就是这个进程中的主线程。

### 线程

线程是比进程更小的**执行单位**。**一个进程在其执行的过程中可以产生多个线程**。与进程不同的是同类的多个线程**共享**进程的**堆**和**方法区**资源,但是每个线程之间切换工作时,负担要比进程小得多,也正因为如此,线程也被称作轻量级进程。
Java程序天生就是多线程程序,我们可以通过JMX来看一下一个普通的Java程序有哪些线程,代码如下:

```java
public class MutiThread{
    public static void main(String[] args){
    
        //获取Java线程管理MXBean
        ThreadMXBean threadMXBean=ManagementFactory.getThreadMXBean();
    
        //不需要获取同步的minitor和synchronizer信息,仅获取线程和线程堆栈信息
        ThreadInfo[] threadInfos=threadMXBean.dumpAllSThreads(false,false);
    
        //遍历线程信息,仅打印线程ID和线程名称信息
        for(ThreadInfo threadInfo:threadInfo){
            System.out.println("["+threadInfo.getThredId()+"]"+threadInfo.getThreadName());
        }
    }
}
```

上述程序输出如下(输出内容不同)：

```shell
 Attach Listener //添加事件
 Signal Dispatcher  //分发处理给JVM信号的线程
 Finalizer //调用对象的 finalize 方法的线程
 Reference Handler //清除 reference 线程
 main //main 线程,程序入口
```

从上面的输出内容可以看出:**一个Java程序的运行是main线程和多个其他线程同时运行**。

## 简要描述线程与进程的关系,区别以及优缺点

### 图解进程和线程的关系

这里用一下Guide的图片
![](https://gitee.com/aryangzhu/picture/raw/master/java/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F.png)
从上面的图片可以看到,JDK1.8之后,方法区变为了**元空间**,但是每个线程有自己的程序计数器、虚拟机栈和本地方法栈。
线程是进程的**更小执行单位**,线程执行开销小,但不利于资源的保护管理,因为执行时会相互影响。

### 为什么程序计数器是私有的？

程序计数器主要有两个作用:

1. **字节码解释器通过改变程序计数器来来依次读取指令**,从而实现代码的流程控制,如:顺序执行、选择、循环、异常处理(说实话不是很明白)
2. 在多线程的情况下,**程序计数器用于记录当前线程执行的位置**,从而当线程被切换回来的时候能够知道该线程上次运行到了什么位置。

需要注意的是,如果执行的是native方法,那么程序计数器记录的是undefined地址,只有执行的是Java代码时程序技术器记录的才是**下一条指令的地址**。
程序计数器的私有主要是为了**线程切换后能回复到正确的执行位置**。

### 为什么虚拟机栈和本地方法栈是私有的？

虚拟机栈:每个Java方法在执行的同时会创建一个**栈帧**用于存储**局部变量表、操作数栈、常量池引用**等信息。从方法调用直至执行完成的过程,就对应着一个栈帧在Java虚拟机栈中入栈和出栈的过程。

### 堆和方法区

堆和方法区是所有线程共享的资源,其中堆是进程中最大的一块内存,主要用于存放新创建的对象(几乎所有的对象都在这里分配内存),方法区用于存放已经被加载的类信息、常量、静态变量、及时编译器后的代码等数据。

### 并发与并行

并发:多个**作业**在同一**时间段内**执行。

并行:多个**作业**在同一时刻执行。

### 为什么要使用多线程

单核时代:如果Java进程中只有一个线程,那么例如IO阻塞时整个进程将被阻塞。而使用多线程的话,那么当一个线程被IO阻塞时,其他线程还可以继续使用CPU。

多核时代:如果只有一个线程的话,那么无论系统有几个CPU,只有一个会被用到。而创建多个线程,这些线程可被映射到底层的多个CPU上执行,在任务中的多线程没有资源竞争的情况下,任务的执行效率会有显著性的提高,约等于单核执行时间/CPU核心数。

### 多线程可能带来的问题

并发编程的目的就是为了能提高程序的执行效率提高程序运行速度,但是并发编程并不总是能提高程序运行速度的,而且并发编程可能会遇到很多问题,比如:内存泄露、死锁、线程不安全等。

### 线程的生命周期和状态

Java线程的6种状态

new **初始状态**,线程被构建,但是还没有调用start()方法。

runnable 运行状态,Java线程将操作系统中的就绪和运行两种状态笼统地称作"运行中"。

blocked 阻塞状态,表示线程阻塞

waiting 等待状态,表示线程进入等待状态,进入该线程表示当前线程需要等待其他线程做出一些特定动作(通知或中断)

time_waiting 超时等待,该状态不同于waiting，它是可以在指定的时间内自行返回的。

terminate 终止状态,表示当前线程已经执行完毕。

![](https://raw.githubusercontent.com/aryangzhu/blogImage/master/%E9%80%89%E5%8C%BA_037.png)

### 什么是上下文切换

线程在执行过程中会有自己的**运行条件和状态**(也称上下文),比如上下文所说到的程序计数器,栈信息等。当出现如下情况的时候,**线程会从占用CPU状态中退出**。

1.主动让出CPU,比如调用了sleep()、wait()等。

2.时间片用完,因为操作系统要防止一个线程或进程长时间占用CPU导致其他线程或者进程饿死。

3.调用了**阻塞类型的系统中断**,比如请求IO,线程被阻塞。

4.被终止或结束运行。

前三种都会发生线程切换,线程切换意味着需要保存当前线程的上下文,**留待线程下次占用CPU的时候恢复现场**,并加载下一个将要占用CPU的线程上下文。这就是所谓的**上下文切换**。

上下文切换是线代操作系统的基本功能,因其每次需要保存信息,这将会占用CPU,内存等系统资源进行处理,也就意味着效率会有一定损耗,如果频繁切换会造成整体效率低下。
